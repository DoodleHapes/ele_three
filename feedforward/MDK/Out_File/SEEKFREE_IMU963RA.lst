C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE SEEKFREE_IMU963RA
OBJECT MODULE PLACED IN .\Out_File\SEEKFREE_IMU963RA.obj
COMPILER INVOKED BY: C:\keil MCK\C251\BIN\C251.EXE SEEKFREE_IMU963RA.c XSMALL INTR2 WARNINGLEVEL(3) OPTIMIZE(0,SPEED) BR
                    -OWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE;..\
                    -USER\inc;..\USER\src) DEBUG PRINT(.\Out_File\SEEKFREE_IMU963RA.lst) TABS(2) OBJECT(.\Out_File\SEEKFREE_IMU963RA.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2018,é€é£ç§‘æŠ€
    4           * All rights reserved.
    5           * æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897
    6           *
    7           * ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±é€é£ç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ï¼Œ
    8           * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ã€‚
    9           *
   10           * @file          IMU963RA
   11           * @company       æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   12           * @author        é€é£ç§‘æŠ€(QQ3184284598)
   13           * @version       æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   14           * @Software    MDK FOR C251 V5.60
   15           * @Target core   STC32G12K128
   16           * @Taobao      https://seekfree.taobao.com/
   17           * @date          2019-04-30
   18           * @note    
   19           * æ¥çº¿å®šä¹‰ï¼š
   20           *                   ------------------------------------
   21           *                   æ¨¡å—ç®¡è„š            å•ç‰‡æœºç®¡è„š
   22           *                   // ç¡¬ä»¶ SPI å¼•è„š
   23           *                   SCL/SPC             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SPC_PIN å®å®šä¹‰
   24           *                   SDA/DSI             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SDI_PIN å®å®šä¹‰
   25           *                   SA0/SDO             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SDO_PIN å®å®šä¹‰
   26           *                   CS                  æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_CS_PIN  å®å®šä¹‰
   27           *                   VCC                 3.3Vç”µæº
   28           *                   GND                 ç”µæºåœ°
   29           *                   å…¶ä½™å¼•è„šæ‚¬ç©º
   30           *
   31           *                   // è½¯ä»¶ IIC å¼•è„š
   32           *                   SCL/SPC             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SCL_PIN å®å®šä¹‰
   33           *                   SDA/DSI             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SDA_PIN å®å®šä¹‰
   34           *                   VCC                 3.3Vç”µæº
   35           *                   GND                 ç”µæºåœ°
   36           *                   å…¶ä½™å¼•è„šæ‚¬ç©º
   37           *                   ------------------------------------
   38          *********************************************************************************************************
             -***********/
   39          
   40          #include "SEEKFREE_IMU963RA.h"
   41          
   42          #include "zf_delay.h"
   43          #include "zf_spi.h"
   44          
   45          
   46          
   47          #pragma warning disable = 177
   48          #pragma warning disable = 183
   49          
   50          
   51          int16 imu963ra_gyro_x = 0, imu963ra_gyro_y = 0, imu963ra_gyro_z = 0;
   52          int16 imu963ra_acc_x = 0,  imu963ra_acc_y = 0,  imu963ra_acc_z = 0;
   53          int16 imu963ra_mag_x = 0,  imu963ra_mag_y = 0,  imu963ra_mag_z = 0;
   54          
   55          #if IMU963RA_USE_SOFT_IIC
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 2   

   56          
   57          
   58          #define GET_IMU963RA_SDA        IMU963RA_SDA_PIN
   59          #define IMU963RA_SDA_LOW()          IMU963RA_SDA_PIN = 0    //IOå£è¾“å‡ºä½ç”µå¹³
   60          #define IMU963RA_SDA_HIGH()         IMU963RA_SDA_PIN = 1    //IOå£è¾“å‡ºé«˜ç”µå¹³
   61          
   62          #define IMU963RA_SCL_LOW()          IMU963RA_SCL_PIN = 0    //IOå£è¾“å‡ºä½ç”µå¹³
   63          #define IMU963RA_SCL_HIGH()         IMU963RA_SCL_PIN = 1    //IOå£è¾“å‡ºé«˜ç”µå¹³
   64          
   65          #define ack 1      //ä¸»åº”ç­”
   66          #define no_ack 0   //ä»åº”ç­”  
   67          
   68          //-------------------------------------------------------------------------------------------------------
             -------------
   69          //  @brief      æ¨¡æ‹ŸIICå»¶æ—¶
   70          //  @return     void            
   71          //  @since      v1.0
   72          //  Sample usage:       å¦‚æœIICé€šè®¯å¤±è´¥å¯ä»¥å°è¯•å¢åŠ jçš„å€¼
   73          //-------------------------------------------------------------------------------------------------------
             -------------
   74          static void imu963ra_simiic_delay(void)
   75          {
   76   1          uint16 j=IMU963RA_SOFT_IIC_DELAY;   
   77   1        while(j--);
   78   1      }
   79          
   80          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
   81          static void imu963ra_simiic_start(void)
   82          {
   83   1        IMU963RA_SDA_HIGH();
   84   1        IMU963RA_SCL_HIGH();
   85   1        imu963ra_simiic_delay();
   86   1        IMU963RA_SDA_LOW();
   87   1        imu963ra_simiic_delay();
   88   1        IMU963RA_SCL_LOW();
   89   1      }
   90          
   91          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
   92          static void imu963ra_simiic_stop(void)
   93          {
   94   1        IMU963RA_SDA_LOW();
   95   1        IMU963RA_SCL_LOW();
   96   1        imu963ra_simiic_delay();
   97   1        IMU963RA_SCL_HIGH();
   98   1        imu963ra_simiic_delay();
   99   1        IMU963RA_SDA_HIGH();
  100   1        imu963ra_simiic_delay();
  101   1      }
  102          
  103          //ä¸»åº”ç­”(åŒ…å«ack:SDA=0å’Œno_ack:SDA=0)
  104          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
  105          static void imu963ra_simiic_sendack(unsigned char ack_dat)
  106          {
  107   1          IMU963RA_SCL_LOW();
  108   1        imu963ra_simiic_delay();
  109   1        if(ack_dat) IMU963RA_SDA_LOW();
  110   1          else      IMU963RA_SDA_HIGH();
  111   1      
  112   1          IMU963RA_SCL_HIGH();
  113   1          imu963ra_simiic_delay();
  114   1          IMU963RA_SCL_LOW();
  115   1          imu963ra_simiic_delay();
  116   1      }
  117          
  118          
  119          static int imu963ra_sccb_waitack(void)
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 3   

  120          {
  121   1          IMU963RA_SCL_LOW();
  122   1      
  123   1        imu963ra_simiic_delay();
  124   1        
  125   1        IMU963RA_SCL_HIGH();
  126   1          imu963ra_simiic_delay();
  127   1        
  128   1          if(GET_IMU963RA_SDA)           //åº”ç­”ä¸ºé«˜ç”µå¹³ï¼Œå¼‚å¸¸ï¼Œé€šä¿¡å¤±è´¥
  129   1          {
  130   2      
  131   2              IMU963RA_SCL_LOW();
  132   2              return 0;
  133   2          }
  134   1      
  135   1          IMU963RA_SCL_LOW();
  136   1        imu963ra_simiic_delay();
  137   1          return 1;
  138   1      }
  139          
  140          //å­—èŠ‚å‘é€ç¨‹åº
  141          //å‘é€c(å¯ä»¥æ˜¯æ•°æ®ä¹Ÿå¯æ˜¯åœ°å€)ï¼Œé€å®Œåæ¥æ”¶ä»åº”ç­”
  142          //ä¸è€ƒè™‘ä»åº”ç­”ä½
  143          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
  144          static void imu963ra_send_ch(uint8 c)
  145          {
  146   1        uint8 i = 8;
  147   1          while(i--)
  148   1          {
  149   2              if(c & 0x80)  IMU963RA_SDA_HIGH();//SDA è¾“å‡ºæ•°æ®
  150   2              else      IMU963RA_SDA_LOW();
  151   2              c <<= 1;
  152   2              imu963ra_simiic_delay();
  153   2              IMU963RA_SCL_HIGH();                //SCL æ‹‰é«˜ï¼Œé‡‡é›†ä¿¡å·
  154   2              imu963ra_simiic_delay();
  155   2              IMU963RA_SCL_LOW();                //SCL æ—¶é’Ÿçº¿æ‹‰ä½
  156   2          }
  157   1        imu963ra_sccb_waitack();
  158   1      }
  159          
  160          
  161          //å­—èŠ‚æ¥æ”¶ç¨‹åº
  162          //æ¥æ”¶å™¨ä»¶ä¼ æ¥çš„æ•°æ®ï¼Œæ­¤ç¨‹åºåº”é…åˆ|ä¸»åº”ç­”å‡½æ•°|ä½¿ç”¨
  163          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
  164          static uint8 imu963ra_read_ch(uint8 ack_x)
  165          {
  166   1          uint8 i;
  167   1          uint8 c;
  168   1          c=0;
  169   1          IMU963RA_SCL_LOW();
  170   1          imu963ra_simiic_delay();
  171   1          IMU963RA_SDA_HIGH();             
  172   1      
  173   1          for(i=0;i<8;i++)
  174   1          {
  175   2              imu963ra_simiic_delay();
  176   2              IMU963RA_SCL_LOW();         //ç½®æ—¶é’Ÿçº¿ä¸ºä½ï¼Œå‡†å¤‡æ¥æ”¶æ•°æ®ä½
  177   2              imu963ra_simiic_delay();
  178   2              IMU963RA_SCL_HIGH();         //ç½®æ—¶é’Ÿçº¿ä¸ºé«˜ï¼Œä½¿æ•°æ®çº¿ä¸Šæ•°æ®æœ‰æ•ˆ
  179   2              imu963ra_simiic_delay();
  180   2              c<<=1;
  181   2              if(GET_IMU963RA_SDA) 
  182   2              {
  183   3                  c+=1;   //è¯»æ•°æ®ä½ï¼Œå°†æ¥æ”¶çš„æ•°æ®å­˜c
  184   3              }
  185   2          }
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 4   

  186   1      
  187   1        IMU963RA_SCL_LOW();
  188   1        imu963ra_simiic_delay();
  189   1        imu963ra_simiic_sendack(ack_x);
  190   1        
  191   1          return c;
  192   1      }
  193          
  194          
  195          //-------------------------------------------------------------------------------------------------------
             -------------
  196          //  @brief      æ¨¡æ‹ŸIICå†™æ•°æ®åˆ°è®¾å¤‡å¯„å­˜å™¨å‡½æ•°
  197          //  @param      dev_add     è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
  198          //  @param      reg       å¯„å­˜å™¨åœ°å€
  199          //  @param      dat       å†™å…¥çš„æ•°æ®
  200          //  @return     void            
  201          //  @since      v1.0
  202          //  Sample usage:       
  203          //-------------------------------------------------------------------------------------------------------
             -------------
  204          static void imu963ra_simiic_write_reg(uint8 dev_add, uint8 reg, uint8 dat)
  205          {
  206   1        imu963ra_simiic_start();
  207   1          imu963ra_send_ch( (dev_add<<1) | 0x00);   //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
  208   1        imu963ra_send_ch( reg );           //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
  209   1        imu963ra_send_ch( dat );           //å‘é€éœ€è¦å†™å…¥çš„æ•°æ®
  210   1        imu963ra_simiic_stop();
  211   1      }
  212          
  213          
  214          
  215          
  216          //-------------------------------------------------------------------------------------------------------
             -------------
  217          //  @brief      æ¨¡æ‹ŸIICä»è®¾å¤‡å¯„å­˜å™¨è¯»å–æ•°æ®
  218          //  @param      dev_add     è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
  219          //  @param      reg       å¯„å­˜å™¨åœ°å€
  220          //  @param      type      é€‰æ‹©é€šä¿¡æ–¹å¼æ˜¯IIC  è¿˜æ˜¯ SCCB
  221          //  @return     uint8     è¿”å›å¯„å­˜å™¨çš„æ•°æ®      
  222          //  @since      v1.0
  223          //  Sample usage:       
  224          //-------------------------------------------------------------------------------------------------------
             -------------
  225          //static uint8 imu963ra_simiic_read_reg(uint8 dev_add, uint8 reg)
  226          //{
  227          //  uint8 dat;
  228          //  imu963ra_simiic_start();
  229          //    imu963ra_send_ch( (dev_add<<1) | 0x00);  //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
  230          //  imu963ra_send_ch( reg );          //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
  231          
  232          //  
  233          //  imu963ra_simiic_start();
  234          //  imu963ra_send_ch( (dev_add<<1) | 0x01);  //å‘é€å™¨ä»¶åœ°å€åŠ è¯»ä½
  235          //  dat = imu963ra_read_ch(no_ack);           //è¯»å–æ•°æ®
  236          //  imu963ra_simiic_stop();
  237          //  
  238          //  return dat;
  239          //}
  240          
  241          
  242          //-------------------------------------------------------------------------------------------------------
             -------------
  243          //  @brief      æ¨¡æ‹ŸIICä»è®¾å¤‡å¯„å­˜å™¨è¯»å–æ•°æ®
  244          //  @param      dev_add     è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
  245          //  @param      reg       å¯„å­˜å™¨åœ°å€
  246          //  @return     uint8     è¿”å›å¯„å­˜å™¨çš„æ•°æ®      
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 5   

  247          //  @since      v1.0
  248          //  Sample usage:       
  249          //-------------------------------------------------------------------------------------------------------
             -------------
  250          static uint8 imu963ra_simiic_sccb_read_reg(uint8 dev_add, uint8 reg)
  251          {
  252   1        uint8 dat;
  253   1        imu963ra_simiic_start();
  254   1          imu963ra_send_ch( (dev_add<<1) | 0x00);  //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
  255   1        imu963ra_send_ch( reg );          //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
  256   1        imu963ra_simiic_stop();
  257   1        
  258   1        imu963ra_simiic_start();
  259   1        imu963ra_send_ch( (dev_add<<1) | 0x01);  //å‘é€å™¨ä»¶åœ°å€åŠ è¯»ä½
  260   1        dat = imu963ra_read_ch(no_ack);           //è¯»å–æ•°æ®
  261   1        imu963ra_simiic_stop();
  262   1        
  263   1        return dat;
  264   1      }
  265          
  266          
  267          //-------------------------------------------------------------------------------------------------------
             -------------
  268          //  @brief      æ¨¡æ‹ŸIICè¯»å–å¤šå­—èŠ‚æ•°æ®
  269          //  @param      dev_add     è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
  270          //  @param      reg       å¯„å­˜å™¨åœ°å€
  271          //  @param      dat_add     æ•°æ®ä¿å­˜çš„åœ°å€æŒ‡é’ˆ
  272          //  @param      num       è¯»å–å­—èŠ‚æ•°é‡
  273          //  @param      type      é€‰æ‹©é€šä¿¡æ–¹å¼æ˜¯IIC  è¿˜æ˜¯ SCCB
  274          //  @return     uint8     è¿”å›å¯„å­˜å™¨çš„æ•°æ®      
  275          //  @since      v1.0
  276          //  Sample usage:       
  277          //-------------------------------------------------------------------------------------------------------
             -------------
  278          static void imu963ra_simiic_read_regs(uint8 dev_add, uint8 reg, uint8 *dat_add, uint32 num)
  279          {
  280   1        imu963ra_simiic_start();
  281   1          imu963ra_send_ch( (dev_add<<1) | 0x00);  //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
  282   1        imu963ra_send_ch( reg );          //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
  283   1      
  284   1        
  285   1        imu963ra_simiic_start();
  286   1        imu963ra_send_ch( (dev_add<<1) | 0x01);  //å‘é€å™¨ä»¶åœ°å€åŠ è¯»ä½
  287   1          while(--num)
  288   1          {
  289   2              *dat_add = imu963ra_read_ch(ack); //è¯»å–æ•°æ®
  290   2              dat_add++;
  291   2          }
  292   1          *dat_add = imu963ra_read_ch(no_ack); //è¯»å–æ•°æ®
  293   1        imu963ra_simiic_stop();
  294   1      }
  295          
  296          
  297          //-------------------------------------------------------------------------------------------------------
             -------------
  298          // å‡½æ•°ç®€ä»‹     IMU963RA å†™å¯„å­˜å™¨
  299          // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
  300          // å‚æ•°è¯´æ˜     dat            æ•°æ®
  301          // è¿”å›å‚æ•°     void
  302          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x00);
  303          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  304          //-------------------------------------------------------------------------------------------------------
             -------------
  305          #define imu963ra_write_acc_gyro_register(reg,dat)       (imu963ra_simiic_write_reg(IMU963RA_DEV_ADDR,reg,
             -dat))
  306          
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 6   

  307          //-------------------------------------------------------------------------------------------------------
             -------------
  308          // å‡½æ•°ç®€ä»‹     IMU963RA è¯»å¯„å­˜å™¨
  309          // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
  310          // è¿”å›å‚æ•°     uint8           æ•°æ®
  311          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER);
  312          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  313          //-------------------------------------------------------------------------------------------------------
             -------------
  314          #define imu963ra_read_acc_gyro_register(reg)             (imu963ra_simiic_sccb_read_reg(IMU963RA_DEV_ADDR
             -,reg))
  315          
  316          //-------------------------------------------------------------------------------------------------------
             -------------
  317          // å‡½æ•°ç®€ä»‹     IMU963RA è¯»æ•°æ® å†…éƒ¨è°ƒç”¨
  318          // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
  319          // å‚æ•°è¯´æ˜     dat            æ•°æ®ç¼“å†²åŒº
  320          // å‚æ•°è¯´æ˜     len             æ•°æ®é•¿åº¦
  321          // è¿”å›å‚æ•°     void
  322          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_A, dat, 6);
  323          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  324          //-------------------------------------------------------------------------------------------------------
             -------------
  325          #define imu963ra_read_acc_gyro_registers(reg,dat,len)   (imu963ra_simiic_read_regs(IMU963RA_DEV_ADDR,reg,
             -dat,len))
  326          
  327          
  328          #else
               
               
               
               #define IMU963RA_SCK(x)       IMU963RA_SPC_PIN  = x
               #define IMU963RA_MOSI(x)      IMU963RA_SDI_PIN = x
               #define IMU963RA_CS(x)        IMU963RA_CS_PIN  = x
               #define IMU963RA_MISO         IMU963RA_SDO_PIN 
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      é€šè¿‡SPIå†™ä¸€ä¸ªbyte,åŒæ—¶è¯»å–ä¸€ä¸ªbyte
               //  @param      byte        å‘é€çš„æ•°æ®    
               //  @return     uint8       return è¿”å›statusçŠ¶æ€
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               static uint8 imu963ra_simspi_wr_byte(uint8 byte)
               {
                   uint8 i;
                 
                   for(i=0; i<8; i++)
                   {
                       IMU963RA_MOSI(byte&0x80);
                       byte <<= 1;
                   IMU963RA_SCK (0);
                   IMU963RA_SCK (0);
                   
                   IMU963RA_SCK (1);
                   IMU963RA_SCK (1);
                   byte |= IMU963RA_MISO; 
                   } 
                   return(byte);                                         
               }
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      å°†valå†™å…¥cmdå¯¹åº”çš„å¯„å­˜å™¨åœ°å€,åŒæ—¶è¿”å›statuså­—èŠ‚
               //  @param      cmd         å‘½ä»¤å­—
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 7   

               //  @param      val         å¾…å†™å…¥å¯„å­˜å™¨çš„æ•°å€¼
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_simspi_w_reg_byte(uint8 cmd, uint8 val)
               {
                   IMU963RA_CS(0);
                   cmd |= IMU963RA_SPI_W;
                   imu963ra_simspi_wr_byte(cmd);                       
                   imu963ra_simspi_wr_byte(val);                                 
                   IMU963RA_CS(1);                                     
               }
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      å°†valå†™å…¥cmdå¯¹åº”çš„å¯„å­˜å™¨åœ°å€
               //  @param      cmd         å‘½ä»¤å­—
               //  @param      val         å¾…å†™å…¥å¯„å­˜å™¨çš„æ•°å€¼
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               //static void imu963ra_simspi_w_reg_bytes(uint8 cmd, uint8 *dat_addr, uint32 len)
               //{
               
               //  
               //    IMU963RA_CS(0);
               //    cmd |= IMU963RA_SPI_W;
               //    imu963ra_simspi_wr_byte(cmd);   
               //  while(len--)
               //  {
               //    imu963ra_simspi_wr_byte(*dat_addr++); 
               //  }                 
               //    IMU963RA_CS(1);                                     
               //}
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      è¯»å–cmdæ‰€å¯¹åº”çš„å¯„å­˜å™¨åœ°å€
               //  @param      cmd         å‘½ä»¤å­—
               //  @param      *val        å­˜å‚¨è¯»å–çš„æ•°æ®åœ°å€
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_simspi_r_reg_byte(uint8 cmd, uint8 *val)
               {
                   IMU963RA_CS(0);
                   cmd |= IMU963RA_SPI_R;
                   imu963ra_simspi_wr_byte(cmd);                                 
                   *val = imu963ra_simspi_wr_byte(0);                            
                   IMU963RA_CS(1);                                     
               }
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      è¯»å–cmdæ‰€å¯¹åº”çš„å¯„å­˜å™¨åœ°å€
               //  @param      cmd         å‘½ä»¤å­—
               //  @param      *val        å­˜å‚¨è¯»å–çš„æ•°æ®åœ°å€
               //  @param      num         è¯»å–çš„æ•°é‡
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 8   

               static void imu963ra_simspi_r_reg_bytes(uint8 cmd, uint8 *val, uint32 num)
               {
               
                   cmd |= IMU963RA_SPI_R;
                   imu963ra_simspi_wr_byte(cmd);
               
                 while(num--)
                 {
                   *val++ = imu963ra_simspi_wr_byte(0);
                 }          
               }
               
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               // å‡½æ•°ç®€ä»‹     IMU963RA å†™å¯„å­˜å™¨
               // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
               // å‚æ•°è¯´æ˜     dat            æ•°æ®
               // è¿”å›å‚æ•°     void
               // ä½¿ç”¨ç¤ºä¾‹     imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x00);
               // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_write_acc_gyro_register(uint8 reg, uint8 dat)
               {
                   IMU963RA_CS(0);
                   imu963ra_simspi_w_reg_byte(reg | IMU963RA_SPI_W, dat);
               
                   IMU963RA_CS(1);
               }
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               // å‡½æ•°ç®€ä»‹     IMU963RA è¯»å¯„å­˜å™¨
               // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
               // è¿”å›å‚æ•°     uint8           æ•°æ®
               // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER);
               // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
               //-------------------------------------------------------------------------------------------------------
             -------------
               static uint8 imu963ra_read_acc_gyro_register(uint8 reg)
               {
                   uint8 dat = 0;
                   IMU963RA_CS(0);
                 imu963ra_simspi_r_reg_byte(reg | IMU963RA_SPI_R , &dat);
                   IMU963RA_CS(1);
                   return dat;
               }
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               // å‡½æ•°ç®€ä»‹     IMU963RA è¯»æ•°æ® å†…éƒ¨è°ƒç”¨
               // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
               // å‚æ•°è¯´æ˜     dat            æ•°æ®ç¼“å†²åŒº
               // å‚æ•°è¯´æ˜     len             æ•°æ®é•¿åº¦
               // è¿”å›å‚æ•°     void
               // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_A, dat, 6);
               // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_read_acc_gyro_registers(uint8 reg, uint8 *dat, uint32 len)
               {
                   IMU963RA_CS(0);
                   imu963ra_simspi_r_reg_bytes( reg | IMU963RA_SPI_R, dat, len);
               
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 9   

                   IMU963RA_CS(1);
               }
               #endif
  486          
  487          //-------------------------------------------------------------------------------------------------------
             -------------
  488          // å‡½æ•°ç®€ä»‹     IMU963RA ä½œä¸º IIC ä¸»æœºå‘ç£åŠ›è®¡å†™æ•°æ®
  489          // å‚æ•°è¯´æ˜     addr            ç›®æ ‡åœ°å€
  490          // å‚æ•°è¯´æ˜     reg             ç›®æ ‡å¯„å­˜å™¨
  491          // å‚æ•°è¯´æ˜     dat            æ•°æ®
  492          // è¿”å›å‚æ•°     uint8           1-å¤±è´¥ 0-æˆåŠŸ
  493          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL2, 0x80);
  494          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  495          //-------------------------------------------------------------------------------------------------------
             -------------
  496          static uint8 imu963ra_write_mag_register (uint8 addr, uint8 reg, uint8 dat)
  497          {
  498   1          uint8 return_state = 0;
  499   1          uint16 timeout_count = 0;
  500   1      
  501   1          addr = addr << 1;
  502   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x00);               // ä»æœº0é…ç½®æ¸…é™¤
  503   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_ADD, addr | 0);              // è®¾ç½®åœ°ç£è®¡åœ°å€ï
             -¼ˆæ³¨æ„è¿™é‡Œéœ€è¦è®¾ç½®8ä½çš„I2Cåœ°å€ï¼‰ 0x2C
  504   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_SUBADD, reg);                // éœ€è¦å†™å…¥çš„å¯„å­˜å
             -™¨åœ°å€
  505   1          imu963ra_write_acc_gyro_register(IMU963RA_DATAWRITE_SLV0, dat);            // éœ€è¦å†™å…¥çš„æ•°æ®
  506   1          imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x4C);             // ä»…åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸå
             -¯ç”¨é€šè®¯ å¼€å¯ä¸Šæ‹‰ I2Cä¸»æœºä½¿èƒ½
  507   1          
  508   1          // ç­‰å¾…é€šè®¯æˆåŠŸ
  509   1          while(0 == (0x80 & imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER)))
  510   1          {
  511   2              if(timeout_count ++ > IMU963RA_TIMEOUT_COUNT)
  512   2              {
  513   3                  return_state = 1;
  514   3                  break;
  515   3              }
  516   2              delay_ms(2);
  517   2          }
  518   1          return return_state;
  519   1      }
  520          
  521          //-------------------------------------------------------------------------------------------------------
             -------------
  522          // å‡½æ•°ç®€ä»‹     IMU963RA ä½œä¸º IIC ä¸»æœºå‘ç£åŠ›è®¡è¯»æ•°æ®
  523          // å‚æ•°è¯´æ˜     addr            ç›®æ ‡åœ°å€
  524          // å‚æ•°è¯´æ˜     reg             ç›®æ ‡å¯„å­˜å™¨
  525          // è¿”å›å‚æ•°     uint8           è¯»å–çš„æ•°æ®
  526          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CHIP_ID);
  527          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  528          //-------------------------------------------------------------------------------------------------------
             -------------
  529          static uint8 imu963ra_read_mag_register (uint8 addr, uint8 reg)
  530          {
  531   1          uint16 timeout_count = 0;
  532   1      
  533   1          addr = addr << 1;
  534   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_ADD, addr | 1);              // è®¾ç½®åœ°ç£è®¡åœ°å€ï
             -¼ˆæ³¨æ„è¿™é‡Œéœ€è¦è®¾ç½®8ä½çš„I2Cåœ°å€ï¼‰ 0x2C
  535   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_SUBADD, reg);                // éœ€è¦è¯»å–çš„å¯„å­˜å
             -™¨åœ°å€
  536   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x01);    
  537   1          imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x4C);             // ä»…åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸå
             -¯ç”¨é€šè®¯ å¼€å¯ä¸Šæ‹‰ I2Cä¸»æœºä½¿èƒ½
  538   1          
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 10  

  539   1          // ç­‰å¾…é€šè®¯æˆåŠŸ
  540   1          while(0 == (0x01 & imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER)))
  541   1          {
  542   2              if(timeout_count ++ > IMU963RA_TIMEOUT_COUNT)
  543   2              {
  544   3                  break;
  545   3              }
  546   2              delay_ms(2);
  547   2          }
  548   1          
  549   1          return (imu963ra_read_acc_gyro_register(IMU963RA_SENSOR_HUB_1));            // è¿”å›è¯»å–åˆ°çš„æ•°æ
             -®
  550   1      }
  551          
  552          //-------------------------------------------------------------------------------------------------------
             -------------
  553          // å‡½æ•°ç®€ä»‹     IMU963RA ä½œä¸º IIC ä¸»æœºå‘ç£åŠ›è®¡è‡ªåŠ¨å†™æ•°æ®
  554          // å‚æ•°è¯´æ˜     addr            ç›®æ ‡åœ°å€
  555          // å‚æ•°è¯´æ˜     reg             ç›®æ ‡å¯„å­˜å™¨
  556          // è¿”å›å‚æ•°     void
  557          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_connect_mag(IMU963RA_MAG_ADDR, IMU963RA_MAG_OUTX_L);
  558          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  559          //-------------------------------------------------------------------------------------------------------
             -------------
  560          static void imu963ra_connect_mag (uint8 addr, uint8 reg)
  561          {
  562   1          addr = addr << 1;
  563   1          
  564   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_ADD, addr | 1);              // è®¾ç½®åœ°ç£è®¡åœ°å€ï
             -¼ˆæ³¨æ„è¿™é‡Œéœ€è¦è®¾ç½®8ä½çš„I2Cåœ°å€ï¼‰ 0x2C
  565   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_SUBADD, reg);                // éœ€è¦è¯»å–çš„å¯„å­˜å
             -™¨åœ°å€
  566   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x06);    
  567   1          imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x6C);             // ä»…åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸå
             -¯ç”¨é€šè®¯ å¼€å¯ä¸Šæ‹‰ I2Cä¸»æœºä½¿èƒ½
  568   1      }   
  569          
  570          
  571          //-------------------------------------------------------------------------------------------------------
             -------------
  572          // å‡½æ•°ç®€ä»‹     IMU963RA å…­è½´è‡ªæ£€ å†…éƒ¨è°ƒç”¨
  573          // å‚æ•°è¯´æ˜     void
  574          // è¿”å›å‚æ•°     uint8           1-è‡ªæ£€å¤±è´¥ 0-è‡ªæ£€æˆåŠŸ
  575          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_acc_gyro_self_check();
  576          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  577          //-------------------------------------------------------------------------------------------------------
             -------------
  578          static uint8 imu963ra_acc_gyro_self_check (void)
  579          {
  580   1          uint8 return_state = 0;
  581   1          uint8 dat = 0;
  582   1          uint16 timeout_count = 0;
  583   1      
  584   1          while(0x6B != dat)                                                          // åˆ¤æ–­ ID æ˜¯å¦æ­£ç¡®
  585   1          {
  586   2              if(timeout_count++ > IMU963RA_TIMEOUT_COUNT)
  587   2              {
  588   3                  return_state = 1;
  589   3                  break;
  590   3              }
  591   2              dat = imu963ra_read_acc_gyro_register(IMU963RA_WHO_AM_I);
  592   2              delay_ms(10);
  593   2          }
  594   1          return return_state;
  595   1      }
  596          
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 11  

  597          //-------------------------------------------------------------------------------------------------------
             -------------
  598          // å‡½æ•°ç®€ä»‹     IMU963RA ç£åŠ›è®¡è‡ªæ£€ å†…éƒ¨è°ƒç”¨
  599          // å‚æ•°è¯´æ˜     void
  600          // è¿”å›å‚æ•°     uint8           1-è‡ªæ£€å¤±è´¥ 0-è‡ªæ£€æˆåŠŸ
  601          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_mag_self_check();
  602          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  603          //-------------------------------------------------------------------------------------------------------
             -------------
  604          static uint8 imu963ra_mag_self_check (void)
  605          {
  606   1          uint8 return_state = 0;
  607   1          uint8 dat = 0;
  608   1          uint16 timeout_count = 0;
  609   1      
  610   1          while(0xff != dat)                                                          // åˆ¤æ–­ ID æ˜¯å¦æ­£ç¡®
  611   1          {
  612   2              if(timeout_count++ > IMU963RA_TIMEOUT_COUNT)
  613   2              {
  614   3                  return_state = 1;
  615   3                  break;
  616   3              }
  617   2              dat = imu963ra_read_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CHIP_ID);
  618   2              delay_ms(10);
  619   2          }
  620   1          return return_state;
  621   1      }
  622          
  623          //-------------------------------------------------------------------------------------------------------
             -------------
  624          // å‡½æ•°ç®€ä»‹     è·å– IMU963RA åŠ é€Ÿåº¦è®¡æ•°æ®
  625          // å‚æ•°è¯´æ˜     void
  626          // è¿”å›å‚æ•°     void
  627          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_get_acc();
  628          // å¤‡æ³¨ä¿¡æ¯     æ‰§è¡Œè¯¥å‡½æ•°åï¼Œç›´æ¥æŸ¥çœ‹å¯¹åº”çš„å˜é‡å³å¯
  629          //-------------------------------------------------------------------------------------------------------
             -------------
  630          void imu963ra_get_acc (void)
  631          {
  632   1          uint8 dat[6];
  633   1      
  634   1          imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_A, dat, 6);
  635   1          imu963ra_acc_x = (int16)(((uint16)dat[1]<<8 | dat[0]));
  636   1          imu963ra_acc_y = (int16)(((uint16)dat[3]<<8 | dat[2]));
  637   1          imu963ra_acc_z = (int16)(((uint16)dat[5]<<8 | dat[4]));
  638   1      }
  639          
  640          
  641          //-------------------------------------------------------------------------------------------------------
             -------------
  642          // å‡½æ•°ç®€ä»‹     è·å–IMU963RAé™€èºä»ªæ•°æ®
  643          // å‚æ•°è¯´æ˜     void
  644          // è¿”å›å‚æ•°     void
  645          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_get_gyro();
  646          // å¤‡æ³¨ä¿¡æ¯     æ‰§è¡Œè¯¥å‡½æ•°åï¼Œç›´æ¥æŸ¥çœ‹å¯¹åº”çš„å˜é‡å³å¯
  647          //-------------------------------------------------------------------------------------------------------
             -------------
  648          void imu963ra_get_gyro (void)
  649          {
  650   1          uint8 dat[6];
  651   1      
  652   1          imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_G, dat, 6);
  653   1          imu963ra_gyro_x = (int16)(((uint16)dat[1]<<8 | dat[0]));
  654   1          imu963ra_gyro_y = (int16)(((uint16)dat[3]<<8 | dat[2]));
  655   1          imu963ra_gyro_z = (int16)(((uint16)dat[5]<<8 | dat[4]));
  656   1      }
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 12  

  657          
  658          
  659          //-------------------------------------------------------------------------------------------------------
             -------------
  660          // å‡½æ•°ç®€ä»‹     è·å– IMU963RA ç£åŠ›è®¡æ•°æ®
  661          // å‚æ•°è¯´æ˜     void
  662          // è¿”å›å‚æ•°     void
  663          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_get_mag();
  664          // å¤‡æ³¨ä¿¡æ¯     æ‰§è¡Œè¯¥å‡½æ•°åï¼Œç›´æ¥æŸ¥çœ‹å¯¹åº”çš„å˜é‡å³å¯
  665          //-------------------------------------------------------------------------------------------------------
             -------------
  666          void imu963ra_get_mag (void)
  667          {
  668   1          uint8 temp_status;
  669   1          uint8 dat[6];
  670   1      
  671   1          imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x40);
  672   1          temp_status = imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER);
  673   1          if(0x01 & temp_status)
  674   1          {
  675   2              imu963ra_read_acc_gyro_registers(IMU963RA_SENSOR_HUB_1, dat, 6);
  676   2              imu963ra_mag_x = (int16)(((uint16)dat[1]<<8 | dat[0]));
  677   2              imu963ra_mag_y = (int16)(((uint16)dat[3]<<8 | dat[2]));
  678   2              imu963ra_mag_z = (int16)(((uint16)dat[5]<<8 | dat[4]));
  679   2          }
  680   1          imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);
  681   1      }
  682          
  683          //-------------------------------------------------------------------------------------------------------
             -------------
  684          // å‡½æ•°ç®€ä»‹     å°† IMU963RA åŠ é€Ÿåº¦è®¡æ•°æ®è½¬æ¢ä¸ºå®é™…ç‰©ç†æ•°æ®
  685          // å‚æ•°è¯´æ˜     gyro_value      ä»»æ„è½´çš„åŠ é€Ÿåº¦è®¡æ•°æ®
  686          // è¿”å›å‚æ•°     void
  687          // ä½¿ç”¨ç¤ºä¾‹     float dat = imu963ra_acc_transition(imu963ra_acc_x);           // å•ä½ä¸º g(m/s^2)
  688          // å¤‡æ³¨ä¿¡æ¯
  689          //-------------------------------------------------------------------------------------------------------
             -------------
  690          float imu963ra_acc_transition (int16 acc_value)
  691          {
  692   1          float acc_dat = 0;
  693   1          switch(IMU963RA_ACC_SAMPLE)
  694   1          {
  695   2              case 0x30: acc_dat = (float)acc_value / 16393; break;                  // 0x30 åŠ é€Ÿåº¦é‡ç¨‹ä¸º
             -:Â±2G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥ 16393 ï¼Œå¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  696   2              case 0x38: acc_dat = (float)acc_value / 8197;  break;                  // 0x38 åŠ é€Ÿåº¦é‡ç¨‹ä¸º
             -:Â±4G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥ 8197 ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  697   2              case 0x3C: acc_dat = (float)acc_value / 4098;  break;                  // 0x3C åŠ é€Ÿåº¦é‡ç¨‹ä¸º
             -:Â±8G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥ 4098 ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  698   2              case 0x34: acc_dat = (float)acc_value / 2049;  break;                  // 0x34 åŠ é€Ÿåº¦é‡ç¨‹ä¸º
             -:Â±16G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥ 2049 ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  699   2              default: break;
  700   2          }
  701   1          return acc_dat;
  702   1      }
  703          
  704          //-------------------------------------------------------------------------------------------------------
             -------------
  705          // å‡½æ•°ç®€ä»‹     å°† IMU963RA é™€èºä»ªæ•°æ®è½¬æ¢ä¸ºå®é™…ç‰©ç†æ•°æ®
  706          // å‚æ•°è¯´æ˜     gyro_value      ä»»æ„è½´çš„é™€èºä»ªæ•°æ®
  707          // è¿”å›å‚æ•°     void
  708          // ä½¿ç”¨ç¤ºä¾‹     float dat = imu963ra_gyro_transition(imu963ra_gyro_x);         // å•ä½ä¸ºÂ°/s
  709          // å¤‡æ³¨ä¿¡æ¯
  710          //-------------------------------------------------------------------------------------------------------
             -------------
  711          float imu963ra_gyro_transition (int16 gyro_value)
  712          {
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 13  

  713   1          float gyro_dat = 0;
  714   1          switch(IMU963RA_GYR_SAMPLE)
  715   1          {
  716   2              case 0x52: gyro_dat = (float)gyro_value / 228.6f;  break;              //  0x52 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±125dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 228.6ï¼Œ   å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  717   2              case 0x50: gyro_dat = (float)gyro_value / 114.3f;  break;              //  0x50 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±250dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 114.3ï¼Œ   å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  718   2              case 0x54: gyro_dat = (float)gyro_value / 57.1f;   break;              //  0x54 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±500dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 57.1ï¼Œ    å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  719   2              case 0x58: gyro_dat = (float)gyro_value / 28.6f;   break;              //  0x58 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±1000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 28.6ï¼Œ    å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  720   2              case 0x5C: gyro_dat = (float)gyro_value / 14.3f;   break;              //  0x5C é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±2000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 14.3ï¼Œ    å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  721   2              case 0x51: gyro_dat = (float)gyro_value / 7.1f;    break;              //  0x51 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±4000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 7.1ï¼Œ     å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  722   2              default: break;
  723   2          }
  724   1          return gyro_dat;
  725   1      }
  726          
  727          //-------------------------------------------------------------------------------------------------------
             -------------
  728          // å‡½æ•°ç®€ä»‹     å°† IMU963RA åœ°ç£è®¡æ•°æ®è½¬æ¢ä¸ºå®é™…ç‰©ç†æ•°æ®
  729          // å‚æ•°è¯´æ˜     mag_value       ä»»æ„è½´çš„åœ°ç£è®¡æ•°æ®
  730          // è¿”å›å‚æ•°     void
  731          // ä½¿ç”¨ç¤ºä¾‹     float dat = imu963ra_mag_transition(imu963ra_mag_x);          // å•ä½ä¸ºG(é«˜æ–¯)
  732          // å¤‡æ³¨ä¿¡æ¯
  733          //-------------------------------------------------------------------------------------------------------
             -------------
  734          float imu963ra_mag_transition (int16 mag_value)
  735          {
  736   1          float mag_dat = 0;
  737   1          switch(IMU963RA_MAG_SAMPLE)
  738   1          {
  739   2              case 0x19: mag_dat = (float)mag_value / 3000;  break;                  //  0x19 ç£åŠ›è®¡é‡ç¨‹ä¸
             -º:8G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥3000ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  740   2              case 0x09: mag_dat = (float)mag_value / 12000; break;                  //  0x09 ç£åŠ›è®¡é‡ç¨‹ä¸
             -º:2G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥12000ï¼Œå¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  741   2              default: break;
  742   2          }
  743   1          return mag_dat;
  744   1      }
  745          
  746          //-------------------------------------------------------------------------------------------------------
             -------------
  747          // å‡½æ•°ç®€ä»‹     åˆå§‹åŒ– IMU963RA
  748          // å‚æ•°è¯´æ˜     void
  749          // è¿”å›å‚æ•°     uint8           1-åˆå§‹åŒ–å¤±è´¥ 0-åˆå§‹åŒ–æˆåŠŸ
  750          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_init();
  751          // å¤‡æ³¨ä¿¡æ¯     
  752          //-------------------------------------------------------------------------------------------------------
             -------------
  753          uint8 imu963ra_init (void)
  754          {
  755   1          uint8 return_state = 0;
  756   1          delay_ms(10);                                                        // ä¸Šç”µå»¶æ—¶
  757   1      
  758   1      //#if IMU963RA_USE_SOFT_IIC
  759   1      //    soft_iic_init(&imu963ra_iic_struct, IMU963RA_DEV_ADDR, IMU963RA_SOFT_IIC_DELAY, IMU963RA_SCL_PIN, I
             -MU963RA_SDA_PIN);
  760   1      //#else
  761   1      //    spi_init(IMU963RA_SPI, SPI_MODE0, IMU963RA_SPI_SPEED, IMU963RA_SPC_PIN, IMU963RA_SDI_PIN, IMU963RA_
             -SDO_PIN, SPI_CS_NULL);
  762   1      //    gpio_init(IMU963RA_CS_PIN, GPO, GPIO_LOW, GPO_PUSH_PULL);
  763   1      //#endif
  764   1      
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 14  

  765   1          do
  766   1          {
  767   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);       // å…³é—­HUBå¯„å­˜å™¨è®¿é
             -—®
  768   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL3_C, 0x01);               // å¤ä½è®¾å¤‡
  769   2              delay_ms(2);                             
  770   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);       // å…³é—­HUBå¯„å­˜å™¨è®¿é
             -—®
  771   2              if(imu963ra_acc_gyro_self_check())                   
  772   2              {                
  773   3      //      while(1)
  774   3      //      {
  775   3              printf( "IMU963RA acc and gyro self check error.\r\n");                    
  776   3      //        delay_ms(200);
  777   3      //      };
  778   3            
  779   3                  
  780   3                  return_state = 1;
  781   3                  break;            
  782   3              }                   
  783   2                                  
  784   2              imu963ra_write_acc_gyro_register(IMU963RA_INT1_CTRL, 0x03);             // å¼€å¯é™€èºä»ª åŠ é€Ÿ
             -åº¦æ•°æ®å°±ç»ªä¸­æ–­
  785   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL1_XL, IMU963RA_GYR_SAMPLE);   // è®¾ç½®åŠ é€Ÿåº¦è®¡
             -é‡ç¨‹ Â±8G ä»¥åŠæ•°æ®è¾“å‡ºé€Ÿç‡ 52hz ä»¥åŠåŠ é€Ÿåº¦ä¿¡æ¯ä»ç¬¬ä¸€çº§æ»¤æ³¢å™¨è¾“å‡º
  786   2              // IMU963RA_CTRL1_XL å¯„å­˜å™¨
  787   2              // è®¾ç½®ä¸º:0x30 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±2G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥16393ï¼Œå¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  788   2              // è®¾ç½®ä¸º:0x38 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±4G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥8197ï¼Œ å¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  789   2              // è®¾ç½®ä¸º:0x3C åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±8G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥4098ï¼Œ å¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  790   2              // è®¾ç½®ä¸º:0x34 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±16G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥2049ï¼Œ å¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  791   2              
  792   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL2_G, IMU963RA_ACC_SAMPLE);    // è®¾ç½®é™€èºä»ªè®¡
             -é‡ç¨‹ Â±2000dps ä»¥åŠæ•°æ®è¾“å‡ºé€Ÿç‡ 208hz
  793   2              // IMU963RA_CTRL2_G å¯„å­˜å™¨
  794   2              // è®¾ç½®ä¸º:0x52 é™€èºä»ªé‡ç¨‹ä¸º:Â±125dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥228.6ï¼Œ   å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  795   2              // è®¾ç½®ä¸º:0x50 é™€èºä»ªé‡ç¨‹ä¸º:Â±250dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥114.3ï¼Œ   å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  796   2              // è®¾ç½®ä¸º:0x54 é™€èºä»ªé‡ç¨‹ä¸º:Â±500dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥57.1ï¼Œ    å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  797   2              // è®¾ç½®ä¸º:0x58 é™€èºä»ªé‡ç¨‹ä¸º:Â±1000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥28.6ï¼Œ    å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  798   2              // è®¾ç½®ä¸º:0x5C é™€èºä»ªé‡ç¨‹ä¸º:Â±2000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥14.3ï¼Œ    å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  799   2              // è®¾ç½®ä¸º:0x51 é™€èºä»ªé‡ç¨‹ä¸º:Â±4000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥7.1ï¼Œ     å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  800   2              
  801   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL3_C, 0x44);               // ä½¿èƒ½é™€èºä»ªæ•°å­—ä
             -½é€šæ»¤æ³¢å™¨
  802   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL4_C, 0x02);               // ä½¿èƒ½æ•°å­—ä½é€šæ»¤æ
             -³¢å™¨
  803   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL5_C, 0x00);               // åŠ é€Ÿåº¦è®¡ä¸é™€èºä
             -»ªå››èˆäº”å…¥
  804   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL6_C, 0x00);               // å¼€å¯åŠ é€Ÿåº¦è®¡é«˜æ
             -€§èƒ½æ¨¡å¼ é™€èºä»ªä½é€šæ»¤æ³¢ 133hz
  805   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL7_G, 0x00);               // å¼€å¯é™€èºä»ªé«˜æ€§è
             -ƒ½æ¨¡å¼ å…³é—­é«˜é€šæ»¤æ³¢
  806   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL9_XL, 0x01);              // å…³é—­I3Cæ¥å£
  807   2      
  808   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x40);       // å¼€å¯HUBå¯„å­˜å™¨è®¿é
             -—® ç”¨äºé…ç½®åœ°ç£è®¡
  809   2              imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x80);         // å¤ä½I2Cä¸»æœº
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  04/12/23  16:30:45  PAGE 15  

  810   2              delay_ms(2);                             
  811   2              imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x00);         // æ¸…é™¤å¤ä½æ ‡å¿—
  812   2              delay_ms(2);
  813   2              
  814   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL2, 0x80);// å¤ä½è¿æ¥çš„å¤–
             -è®¾
  815   2              delay_ms(2);
  816   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL2, 0x00);
  817   2              delay_ms(2);
  818   2              
  819   2              
  820   2              if(imu963ra_mag_self_check())
  821   2              {
  822   3      //      while(1)
  823   3      //      {
  824   3              printf("IMU963RA mag self check error.\r\n");
  825   3      //        delay_ms(200);
  826   3      //      };
  827   3            
  828   3                  
  829   3                  return_state = 1;
  830   3                  break;            
  831   3              }
  832   2      
  833   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL1, IMU963RA_MAG_SAMPLE); // è®
             -¾ç½®ç£åŠ›è®¡é‡ç¨‹8G è¾“å‡ºé€Ÿç‡100hz è¿ç»­æ¨¡å¼
  834   2              // IMU963RA_MAG_ADDR å¯„å­˜å™¨
  835   2              // è®¾ç½®ä¸º:0x19 ç£åŠ›è®¡é‡ç¨‹ä¸º:8G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥3000ï¼Œ å¯ä»¥è½
             -¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  836   2              // è®¾ç½®ä¸º:0x09 ç£åŠ›è®¡é‡ç¨‹ä¸º:2G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥12000ï¼Œå¯ä»¥è½
             -¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  837   2              
  838   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_FBR, 0x01);
  839   2              imu963ra_connect_mag(IMU963RA_MAG_ADDR, IMU963RA_MAG_OUTX_L);
  840   2              
  841   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);       // å…³é—­HUBå¯„å­˜å™¨è®¿é
             -—®
  842   2      
  843   2              delay_ms(20);                                                    // ç­‰å¾…ç£åŠ›è®¡è·å–æ•°æ®
  844   2          }while(0);
  845   1          return return_state;
  846   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      2095     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       100     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       129     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
